define("mod_codescore/reports",["exports","mod_codescore/tabulatorlib","core/str","core/ajax"],(function(_exports,_tabulatorlib,_str,_ajax){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * JS actions.
   *
   * @module      mod_codescore/reports
   * @copyright   2024 Devlion <info@devlion.co>
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_tabulatorlib=_interopRequireDefault(_tabulatorlib),_ajax=_interopRequireDefault(_ajax);_exports.init=async data=>{const rawParams=window.location.search,urlParams=new URLSearchParams(rawParams),cmid=urlParams.get("id")?urlParams.get("id"):urlParams.get("cmid"),dateFormatter=cell=>{const value=cell.getValue();if("0"===value)return"";return new Date(1e3*Number(value)).toString().split("GMT")[0]};let inprogress=await(0,_str.get_string)("submittedstatus","mod_codescore"),finished=await(0,_str.get_string)("finishedstatus","mod_codescore"),pending=await(0,_str.get_string)("pendingstatus","mod_codescore");if(!data.attempts[0]){document.getElementsByClassName("reportTitle")[0].className+=" hidden",document.getElementById("tableWrapper").className+=" hidden";let noReports=await(0,_str.get_string)("noreports","mod_codescore");document.getElementById("page-mod-codescore-reports")&&(document.querySelector("[role=main]").innerHTML="<h3>".concat(noReports,"</h3>"))}let tabledata=data.attempts,table=new _tabulatorlib.default("#tableWrapper",{data:tabledata,layout:"fitColumns",textDirection:"ltr",columns:[{title:"",field:"deletebtn",widthGrow:.1,formatter:cell=>{const index=cell.getRow().getIndex();return'<input type="checkbox" data-id="'.concat(index,'" class="tabulatorSelect"/>')},hozAlign:"center",vertAlign:"center",headerSort:!1,resizable:!1},{title:await(0,_str.get_string)("tablename","mod_codescore"),field:"username",formatter:cell=>{const name=cell.getValue(),index=Number(cell.getRow().getIndex()),attempt=cell.getRow().getData().attempt;let userid;return userid=document.getElementById("page-mod-codescore-view")?data.attempts[0].userid:cell.getRow().getData().userid,cell.getRow().getElement().addEventListener("click",(()=>{window.location.href="report.php?cmid=".concat(cmid,"&userid=").concat(userid,"&attempt=").concat(attempt,"&index=").concat(index)})),"<a href='report.php?cmid=".concat(cmid,"&userid=").concat(userid,"&attempt=").concat(attempt,"&index=").concat(index,"'>")+name+"</a>"},resizable:!1,widthGrow:1.5},{title:await(0,_str.get_string)("startedat","mod_codescore"),field:"timestart",formatter:dateFormatter,resizable:!1,widthGrow:1.5},{title:await(0,_str.get_string)("timefinish","mod_codescore"),field:"timefinish",formatter:dateFormatter,resizable:!1,widthGrow:1.5},{title:await(0,_str.get_string)("timegraded","mod_codescore"),field:"timegraded",formatter:dateFormatter,resizable:!1,widthGrow:1.5},{title:await(0,_str.get_string)("tableteachergrade","mod_codescore"),field:"grade",formatter:cell=>{if("0"===cell.getRow().getData().timegraded)return"";const value=cell.getValue();return Number(value)},resizable:!1},{title:await(0,_str.get_string)("tableaigrade","mod_codescore"),field:"aigrade",formatter:cell=>null===cell.getValue()?"":Number(cell.getValue()),resizable:!1},{title:await(0,_str.get_string)("statusattempt","mod_codescore"),field:"state",formatter:cell=>{let result;switch(cell.getValue()){case"inprogress":result=inprogress;break;case"finished":result=finished;break;case"pending":result=pending}return result},resizable:!1}]});const modifyBtns=()=>{const deleteBtn=document.getElementById("deleteAttempts"),regradeBtn=document.getElementById("regradeAttempts");table.getSelectedData()[0]?(deleteBtn.className="btn btn-secondary mb-2",regradeBtn.className="btn btn-secondary mb-2"):(deleteBtn.className="disabled btn btn-secondary mb-2",regradeBtn.className="disabled btn btn-secondary mb-2")};table.on("renderComplete",(()=>{document.querySelectorAll(".tabulatorSelect").forEach((el=>{el.addEventListener("click",(e=>{document.querySelectorAll(".tabulatorSelect:not(:checked)")[0]||(checkallbox.checked=!0),e.stopPropagation();const id=e.target.dataset.id;e.target.checked?table.selectRow(Number(id)):(table.deselectRow(Number(id)),checkallbox.checked=!1),modifyBtns()}))}))}));const checkallbox=document.getElementById("checkallcheckbox");document.getElementById("regradeAttempts").addEventListener("click",(async()=>{if(!table.getSelectedData())return;const selected=table.getSelectedData().map((el=>el.id));await _ajax.default.call([{methodname:"mod_codescore_regrade_attempts",args:{ids:selected.join(",")}}]),location.reload()})),document.getElementById("deleteAttemptsConfirm").addEventListener("click",(async()=>{if(!table.getSelectedData())return;const selected=table.getSelectedData().map((el=>el.id));await _ajax.default.call([{methodname:"mod_codescore_delete_attempts",args:{ids:selected.join(","),cmid:cmid}}]),location.reload()})),data.candelete||table.on("tableBuilt",(function(){table.getColumns()[0].delete()}));checkallbox.addEventListener("change",(()=>{var value;if(value=checkallbox.checked,Array.from(document.getElementsByClassName("tabulatorSelect")).forEach((el=>{el.checked=value})),checkallbox.checked)return table.selectRow("visible"),void modifyBtns();table.deselectRow("visible"),modifyBtns()}))}}));

//# sourceMappingURL=reports.min.js.map